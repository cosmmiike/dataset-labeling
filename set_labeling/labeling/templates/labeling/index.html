{% load static %}
{% load labeling_extras %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="{% static "labeling/styles/style.css" %}">
  <title>Dataset Labeling</title>
</head>

<body>
  <div class="labeling">
    <h1 class="labeling__title">Dataset Labeling</h1>
    <div class = "labeling__photo">
      <img class = "labeling__img" src="{% static photo %}" alt="Test photo" width="350">
      <p class = "labeling__img-link">{{ photo }}</p>
    </div>
    <form action="?id_photo={{ photo_num|add:1 }}" class="sets" method="POST">
      {% csrf_token %}
      <input type="hidden" name="photo-url" value="{{ photo }}">
      <ul class="sets__list">
        {% for key, set in sets.items %}
        <li class="set" id="set-{{ forloop.counter }}">
          <p class="set__title">{{ key }}</p>
          <ul class="set__items">
            {% if img_data == None %}
              {% for item in set %}
                <li class="set__item">
                  <input class="set__input" type="radio" id="{{ key }}-radio-{{ forloop.counter }}" name="{{ key }}-radio" value="{{ forloop.counter0 }}" required>
                  <label class="set__label" for="{{ key|add:"-radio-" }}{{ forloop.counter }}">
                    <span class="set__label-num">{{ forloop.counter }}</span>
                    {{ item }}
                  </label>
                </li>
              {% endfor %}
            {% else %}
            {% for item in set %}
              <li class="set__item">
                {% with data_key=img_data|get_item:key %}
                  {% if forloop.counter0 == data_key|to_int %}
                    <input class="set__input" type="radio" id="{{ key|add:"-radio-" }}{{ forloop.counter }}" name="{{ key|add:"-radio" }}" value="{{ forloop.counter0 }}" checked required>
                  {% else %}
                    <input class="set__input" type="radio" id="{{ key|add:"-radio-" }}{{ forloop.counter }}" name="{{ key|add:"-radio" }}" value="{{ forloop.counter0 }}">
                  {% endif %}
                {% endwith %}
                <label class="set__label" for="{{ key|add:"-radio-" }}{{ forloop.counter }}">
                  <span class="set__label-num">{{ forloop.counter }}</span>
                  {{ item }}
                </label>
              </li>
            {% endfor %}
            {%  endif %}
          </ul>
        </li>
        {% endfor %}
      </ul>
      <input class="set__submit" type="submit" value="Save & Go to the next photo" name="save-next">
      <a class="set__switch-link" id="switch-prev" href="?id_photo={{ photo_num|add:-1 }}">← Prev</a>
      <a class="set__switch-link" id="switch-next" href="?id_photo={{ photo_num|add:1 }}">Next →</a>
    </form>
  </div>

  <script type="text/javascript" src="{% static "labeling/scripts/jquery-3.3.1.min.js" %}"></script>
  <script type="text/javascript">

    $(".set__items").focusin(function() {
      $(this).parent().addClass("focused");
    });

    $(".set__items").focusout(function() {
      $(this).parent().removeClass("focused");
    });

    if (!$('input[type="radio"]:checked')[0]) {
      $('input[type="radio"]').eq(0).attr("checked", "checked");
    }

    $('input[type="radio"]:checked')[0].focus();

    $(document).keydown(function( event ) {
      if ( event.altKey && event.which == 37 ) {
        event.preventDefault();
        document.location.href = "?id_photo={{ photo_num|add:-1 }}";
      }

      if ( event.altKey && event.which == 39 ) {
        event.preventDefault();
        document.location.href = "?id_photo={{ photo_num|add:1 }}";
      }

      if ( event.which == 38 ) {
        event.preventDefault();
        var idFocusedSet = Number($(".set.focused")[0].getAttribute('id').replace(/\D/g, ''));
        var idNextFocusedSet = idFocusedSet - 1;
        if (idNextFocusedSet < 1) {
          idNextFocusedSet = {{ sets|length }};
        }
        var nextFocusedSet = $("#set-" + idNextFocusedSet)[0];
        if (!$('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0]) {
          $('input[type="radio"]', "#set-" + idNextFocusedSet).eq(0).attr("checked", "checked");
        }
        $('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0].focus();
      }

      if ( event.which == 40 ) {
        event.preventDefault();
        var idFocusedSet = Number($(".set.focused")[0].getAttribute('id').replace(/\D/g, ''));
        var idNextFocusedSet = idFocusedSet + 1;
        if (idNextFocusedSet > {{ sets|length }}) {
          idNextFocusedSet = 1;
        }
        var nextFocusedSet = $("#set-" + idNextFocusedSet)[0];
        if (!$('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0]) {
          $('input[type="radio"]', "#set-" + idNextFocusedSet).eq(0).attr("checked", "checked");
        }
        $('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0].focus();
      }
    });
  </script>
</body>

</html>
