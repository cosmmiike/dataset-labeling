{% load static %}
{% load labeling_extras %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="{% static "labeling/styles/style.css" %}">
  <title>Dataset Labeling</title>
</head>

<body>
  <div class="labeling">
    <h1 class="labeling__title">Dataset Labeling</h1>
    <div class="labeling__container">
      <div class = "labeling__photo">
        <img class = "labeling__img" src="{% static photo %}" alt="Test photo" width="350">
        <div class="labeling__img-url">
          <p class = "labeling__url">{{ photo }}</p>
          <a href="" class="labeling__copy-url">Copy image url</a>
        </div>
      </div>
      <p class="fix"></p>
    </div>
    <form class="sets" action="?id_photo={{ photo_num|add:1 }}" method="POST">
      {% csrf_token %}
      <input type="hidden" name="photo-url" value="{{ photo }}">
      <ul class="sets__list">
        {% for key, set in sets.items %}
        <li class="set" id="set-{{ forloop.counter }}">
          <p class="set__title">{{ key }}</p>
          <ul class="set__items">
            {% if img_data == None %}
              {% for item in set %}
                <li class="set__item">
                  <input class="set__input" type="radio" id="{{ key }}-radio-{{ forloop.counter }}" name="{{ key }}-radio" value="{{ forloop.counter0 }}" required>
                  <label class="set__label" for="{{ key|add:"-radio-" }}{{ forloop.counter }}">
                    <span class="set__label-num">{{ forloop.counter }}</span>
                    {{ item }}
                  </label>
                </li>
              {% endfor %}
            {% else %}
            {% for item in set %}
              <li class="set__item">
                {% with data_key=img_data|get_item:key %}
                  {% if forloop.counter0 == data_key|to_int %}
                    <input class="set__input" type="radio" id="{{ key|add:"-radio-" }}{{ forloop.counter }}" name="{{ key|add:"-radio" }}" value="{{ forloop.counter0 }}" checked required>
                  {% else %}
                    <input class="set__input" type="radio" id="{{ key|add:"-radio-" }}{{ forloop.counter }}" name="{{ key|add:"-radio" }}" value="{{ forloop.counter0 }}" required>
                  {% endif %}
                {% endwith %}
                <label class="set__label" for="{{ key|add:"-radio-" }}{{ forloop.counter }}">
                  <span class="set__label-num">{{ forloop.counter }}</span>
                  {{ item }}
                </label>
              </li>
            {% endfor %}
            {%  endif %}
          </ul>
        </li>
        {% endfor %}
      </ul>
      <input class="set__submit" type="submit" value="Save & Go to the next picture" name="save-next">
      <div class="set__switch">
        <a class="set__switch-link" id="switch-prev" href="?id_photo={{ photo_num|add:-1 }}">← Prev</a>
        <a class="set__switch-link" id="switch-next" href="?id_photo={{ photo_num|add:1 }}">Next →</a>
      </div>
    </form>
  </div>

  <script type="text/javascript" src="{% static "labeling/scripts/jquery-3.3.1.min.js" %}"></script>
  <script type="text/javascript">
    $(".set__items").focusin(function() {
      $(this).parent().addClass("set--focused");
    });

    $(".set__items").focusout(function() {
      $(this).parent().removeClass("set--focused");
    });

    if (!$('input[type="radio"]:checked')[0]) {
      $('input[type="radio"]').eq(0).prop("checked", true);
    }

    $('input[type="radio"]:checked')[0].focus();

    $(document).keydown(function(event) {
      if (event.altKey && event.which == 37) {
        event.preventDefault();
        document.location.href = "?id_photo={{ photo_num|add:-1 }}";
      }

      if (event.altKey && event.which == 39) {
        event.preventDefault();
        document.location.href = "?id_photo={{ photo_num|add:1 }}";
      }

      if ( event.which == 38 || event.which == 40 ) {
        event.preventDefault();
        var focusedSet = $(".set--focused")[0];
        if (!focusedSet) {
          if (event.which == 38) {
            var idNextFocusedSet = {{ sets|length }};
          } else {
            var idNextFocusedSet = 1;
          }
        } else {
          var idFocusedSet = Number(focusedSet.getAttribute('id').replace(/\D/g, ''));
          if (event.which == 38) {
            var idNextFocusedSet = idFocusedSet - 1;
          } else {
            var idNextFocusedSet = idFocusedSet + 1;
          }
          if (idNextFocusedSet > {{ sets|length }}) {
            idNextFocusedSet = 1;
          } else if (idNextFocusedSet < 1) {
            idNextFocusedSet = {{ sets|length }};
          }
        }

        var nextFocusedSet = $("#set-" + idNextFocusedSet)[0];
        if (!$('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0]) {
          $('input[type="radio"]', "#set-" + idNextFocusedSet).eq(0).prop("checked", true);
        }
        $('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0].focus();
      }

      if ( event.which >= 49 && event.which <= 57  ) {
        event.preventDefault();
        var keycode = event.which;
        var keysymbol = Number(String.fromCharCode(keycode));
        var idFocusedSet = Number($(".set--focused")[0].getAttribute('id').replace(/\D/g, ''));
        if (keysymbol <= $(".set--focused .set__items .set__item").length) {
          $('input[type="radio"]:checked', "#set-" + idFocusedSet).eq(0).prop("checked", false);
          $('input[type="radio"]', "#set-" + idFocusedSet).eq(keysymbol - 1).prop("checked", true);
          $('input[type="radio"]:checked', "#set-" + idFocusedSet)[0].focus();

          var idNextFocusedSet = idFocusedSet + 1;
          if (idNextFocusedSet > {{ sets|length }}) {
            idNextFocusedSet = 1;
          }
          var nextFocusedSet = $("#set-" + idNextFocusedSet)[0];
          if (!$('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0]) {
            $('input[type="radio"]', "#set-" + idNextFocusedSet).eq(0).prop("checked", true);
          }
          $('input[type="radio"]:checked', "#set-" + idNextFocusedSet)[0].focus();
        }
      }
    });
  </script>
</body>

</html>
